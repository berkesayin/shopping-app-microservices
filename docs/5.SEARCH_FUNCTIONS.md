# Search Examples

### Search Service

Make sure `config-server`, `discovery`, `search`, `gateway` services and `Elasticsearch` instance are running.

These are the examples for `search` service's `use cases`. 

### Search Examples - Use Case 1

`Use Case 1`: For `autocomplete()` method from `ProductSearchController`.

`Auto Complete`

- A user starts typing `sweat` in the search bar. User expects to get `product names` that begin with these letters, like `Sweatshirt - blue`.

- `Kibana Dev Tools Query`: The `edge_ngram` analyzer configured means that a simple `match query` against the `.autocomplete` field is all needed to find prefixes.

`Kibana Dev Tools Request`

```json
GET product/_search
{
  "query": {
    "match": {
      "product_name.autocomplete": "sweat"
    }
  },
  "_source": ["product_name"],
  "size": 5
}
```

`Response`

```json
{
  "took": 12,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 244,
      "relation": "eq"
    },
    "max_score": 3.622423,
    "hits": [
      {
        "_index": "product",
        "_id": "20621",
        "_score": 3.622423,
        "_source": {
          "product_name": "Sweatshirt - tan"
        }
      },
      {
        "_index": "product",
        "_id": "24091",
        "_score": 3.622423,
        "_source": {
          "product_name": "Sweatshirt - red"
        }
      },
      {
        "_index": "product",
        "_id": "16427",
        "_score": 3.622423,
        "_source": {
          "product_name": "Sweatshirt - red"
        }
      },
      {
        "_index": "product",
        "_id": "16230",
        "_score": 3.622423,
        "_source": {
          "product_name": "Sweatshirt - Red"
        }
      },
      {
        "_index": "product",
        "_id": "7061",
        "_score": 3.622423,
        "_source": {
          "product_name": "Sweatshirt - red"
        }
      }
    ]
  }
}
```

`Postman Request`

- `Request Method`: `GET`
- `Request URL`: `http://localhost:8222/api/v1/search/products/autocomplete?query=sweat`

`Response`

```json
{
    "suggestions": [
        "Sweatshirt - tan",
        "Sweatshirt - red",
        "Sweatshirt - Red",
        "Sweatshirt - oliv",
        "Sweatshirt - rose",
        "Sweatshirt - navy ",
        "Sweatshirt - grey",
        "Sweatshirt - blue",
        "Sweatshirt - camo",
        "Sweatshirt - navy"
    ]
}
```

`NOTE`: The response for `getAutocompleteSuggestions` method at `search` service is limited to `10` records. Increase it if you prefer.

### Search Examples - Use Case 2

`Use Case 2`: For `searchProducts()` method from `ProductSearchController`.

`Basic text search`

- A user types a general term like `shoes` into the search bar. User expects to get all `products` where `shoes` appears in the `name`, `category`, or `manufacturer` description, with the most relevant results appearing first.

- `Kibana Dev Tools Query`: This shows the `multi_match` query for `relevance scoring`, the essential filter 
for only `active products`, and the `aggregations` that power the filter sidebar.

`Kibana Dev Tools Request`

```json
POST product/_search
{
  "from": 0,
  "size": 5,
  "query": {
    "bool": {
      "must": [
        {
          "multi_match": {
            "query": "shoes",
            "fields": ["product_name", "category.name", "manufacturer"],
            "fuzziness": "AUTO"
          }
        }
      ],
      "filter": [
        {
          "term": { "status": true }
        }
      ]
    }
  },
  "aggs": {
    "category_agg": {
      "terms": { "field": "category.name.keyword" }
    },
    "manufacturer_agg": {
      "terms": { "field": "manufacturer.keyword" }
    }
  }
}
```

`Response`

```json
{
  "took": 4,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1782,
      "relation": "eq"
    },
    "max_score": 7.2187333,
    "hits": [
      {
        "_index": "product",
        "_id": "20267",
        "_score": 7.2187333,
        "_source": {
          "min_price": 13.92,
          "created_on": "2016-12-18T06:31:41+00:00",
          "product_id": "20267",
          "base_price": 28.99,
          "category": {
            "name": "Women's Shoes",
            "id": "3"
          },
          "sku": "ZO0216802168",
          "product_name": "Sports shoes - black",
          "manufacturer": "Pyramidustries active",
          "status": true
        }
      },
      {
        "_index": "product",
        "_id": "10754",
        "_score": 7.2187333,
        "_source": {
          "min_price": 14.03,
          "created_on": "2016-12-20T01:58:05+00:00",
          "product_id": "10754",
          "base_price": 25.99,
          "category": {
            "name": "Women's Shoes",
            "id": "3"
          },
          "sku": "ZO0216002160",
          "product_name": "Sports shoes - darkblue",
          "manufacturer": "Pyramidustries active",
          "status": true
        }
      },
      {
        "_index": "product",
        "_id": "10729",
        "_score": 6.4092646,
        "_source": {
          "min_price": 16.82,
          "created_on": "2016-12-15T21:04:19+00:00",
          "product_id": "10729",
          "base_price": 32.99,
          "category": {
            "name": "Women's Shoes",
            "id": "3"
          },
          "sku": "ZO0216402164",
          "product_name": "Sports shoes - dark blue",
          "manufacturer": "Pyramidustries active",
          "status": true
        }
      },
      {
        "_index": "product",
        "_id": "10829",
        "_score": 6.4092646,
        "_source": {
          "min_price": 15.07,
          "created_on": "2016-12-13T03:17:17+00:00",
          "product_id": "10829",
          "base_price": 28.99,
          "category": {
            "name": "Women's Shoes",
            "id": "3"
          },
          "sku": "ZO0216502165",
          "product_name": "Sports shoes - black/pink",
          "manufacturer": "Pyramidustries active",
          "status": true
        }
      },
      {
        "_index": "product",
        "_id": "3904",
        "_score": 6.4092646,
        "_source": {
          "min_price": 12.99,
          "created_on": "2016-12-21T14:12:29+00:00",
          "product_id": "3904",
          "base_price": 24.99,
          "category": {
            "name": "Men's Shoes",
            "id": "5"
          },
          "sku": "ZO0614606146",
          "product_name": "Neutral running shoes - black",
          "manufacturer": "Spritechnologies",
          "status": true
        }
      }
    ]
  },
  "aggregations": {
    "category_agg": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "Women's Shoes",
          "doc_count": 1124
        },
        {
          "key": "Men's Shoes",
          "doc_count": 658
        }
      ]
    },
    "manufacturer_agg": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 27,
      "buckets": [
        {
          "key": "Low Tide Media",
          "doc_count": 429
        },
        {
          "key": "Tigress Enterprises",
          "doc_count": 320
        },
        {
          "key": "Angeldale",
          "doc_count": 298
        },
        {
          "key": "Oceanavigations",
          "doc_count": 234
        },
        {
          "key": "Elitelligence",
          "doc_count": 170
        },
        {
          "key": "Pyramidustries",
          "doc_count": 145
        },
        {
          "key": "Gnomehouse",
          "doc_count": 64
        },
        {
          "key": "Primemaster",
          "doc_count": 54
        },
        {
          "key": "",
          "doc_count": 29
        },
        {
          "key": "Microlutions",
          "doc_count": 12
        }
      ]
    }
  }
}
```

`Postman Request`

- `Request Method`: `POST`
- `Request URL`: `http://localhost:8222/api/v1/search/products`
- `Request Body`:
```json 
{
  "query": "shoes",
  "page": 0,
  "size": 5
}
```

`Response`

```json
{
    "products": [
        {
            "productId": 20267,
            "productName": "Sports shoes - black",
            "category": {
                "id": "3",
                "name": "Women's Shoes"
            },
            "basePrice": 28.99,
            "minPrice": 13.92,
            "manufacturer": "Pyramidustries active",
            "sku": "ZO0216802168",
            "createdOn": "2016-12-18T06:31:41Z"
        },
        {
            "productId": 10754,
            "productName": "Sports shoes - darkblue",
            "category": {
                "id": "3",
                "name": "Women's Shoes"
            },
            "basePrice": 25.99,
            "minPrice": 14.03,
            "manufacturer": "Pyramidustries active",
            "sku": "ZO0216002160",
            "createdOn": "2016-12-20T01:58:05Z"
        },
        {
            "productId": 10729,
            "productName": "Sports shoes - dark blue",
            "category": {
                "id": "3",
                "name": "Women's Shoes"
            },
            "basePrice": 32.99,
            "minPrice": 16.82,
            "manufacturer": "Pyramidustries active",
            "sku": "ZO0216402164",
            "createdOn": "2016-12-15T21:04:19Z"
        },
        {
            "productId": 10829,
            "productName": "Sports shoes - black/pink",
            "category": {
                "id": "3",
                "name": "Women's Shoes"
            },
            "basePrice": 28.99,
            "minPrice": 15.07,
            "manufacturer": "Pyramidustries active",
            "sku": "ZO0216502165",
            "createdOn": "2016-12-13T03:17:17Z"
        },
        {
            "productId": 3904,
            "productName": "Neutral running shoes - black",
            "category": {
                "id": "5",
                "name": "Men's Shoes"
            },
            "basePrice": 24.99,
            "minPrice": 12.99,
            "manufacturer": "Spritechnologies",
            "sku": "ZO0614606146",
            "createdOn": "2016-12-21T14:12:29Z"
        }
    ],
    "aggregations": [
        {
            "name": "manufacturer_agg",
            "buckets": [
                {
                    "key": "Low Tide Media",
                    "count": 429
                },
                {
                    "key": "Tigress Enterprises",
                    "count": 320
                },
                {
                    "key": "Angeldale",
                    "count": 298
                },
                {
                    "key": "Oceanavigations",
                    "count": 234
                },
                {
                    "key": "Elitelligence",
                    "count": 170
                },
                {
                    "key": "Pyramidustries",
                    "count": 145
                },
                {
                    "key": "Gnomehouse",
                    "count": 64
                },
                {
                    "key": "Primemaster",
                    "count": 54
                },
                {
                    "key": "",
                    "count": 29
                },
                {
                    "key": "Microlutions",
                    "count": 12
                },
                {
                    "key": "Pyramidustries active",
                    "count": 11
                },
                {
                    "key": "Karmanite",
                    "count": 10
                },
                {
                    "key": "Spritechnologies",
                    "count": 6
                }
            ]
        },
        {
            "name": "category_agg",
            "buckets": [
                {
                    "key": "Women's Shoes",
                    "count": 1124
                },
                {
                    "key": "Men's Shoes",
                    "count": 658
                }
            ]
        }
    ],
    "totalHits": 1782,
    "totalPages": 357
}
```
